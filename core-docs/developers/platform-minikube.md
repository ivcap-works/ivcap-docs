# Installing and configuring the Minikube Kubernetes cluster

There are two steps to deploying IVCAP in a
[Minikube](https://minikube.sigs.k8s.io/) Kubernetes cluster. In the first step,
Minikube [requirements](#minikube-requirements) are installed on the host
machine. In the second step the Minikube Kubernetes cluster is [created and
configured](#minikube-create-cluster).


## Requirements <a name="minikube-requirements"></a>

The following dependencies are required to run IVCAP in a Minikube cluster.

- [Go](https://go.dev/doc/install)
- [Docker](https://docs.docker.com/engine/install/)
- [yq](https://mikefarah.gitbook.io/yq/v/v3.x/) (command-line YAML processor)
- [Minikube](https://minikube.sigs.k8s.io/docs/start/) (local Kubernetes cluster)
- [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux) (Kubernetes command-line tool)
- [Helm](https://helm.sh/docs/intro/install/) (package manager for Kubernetes)
- [Argo](https://github.com/argoproj/argo-workflows/releases) (Workflow engine
  for Kubernetes)
- [gcloud](https://cloud.google.com/sdk/docs/install) (Google Cloud CLI tools)
    - When initialising the `gcloud` CLI tool, you will need to [create a
      credential file](https://cloud.google.com/docs/authentication/provide-credentials-adc).

If you use the automation scripts described in the [section
below](#minikube-on-demand), the following dependencies are also required:

- [expect](https://core.tcl-lang.org/expect/index) (Tool for automating
  interactive scripts. Generally available through your package manager.)

## Minikube Cluster On-Demand <a name="minikube-on-demand"></a>

This documentation outlines the automation scripts developed to streamline the process of managing a Minikube cluster. The scripts described below facilitate the execution of tasks detailed in the [Creating the Minikube Cluster](#minikube-create-cluster) section.

#### `deploy/minikube/minikube-start.sh` <a name="deploy-minikube-start"></a>

The `deploy/minikube/minikube-start.sh` script is designed to initialise a fresh Minikube cluster. This script can be invoked conveniently from the main `Makefile` by executing the command `make minikube-start`.

The script can also be invoked directly using the following command:
```bash
./deploy/minikube/minikube-start.sh
```

#### `deploy/minikube/minikube-stop.sh` <a name="deploy-minikube-stop"></a>

The `deplooy/minikube/minikube-stop.sh` script is responsible for completely dismantling the Minikube cluster. Similar to the start script, it can be invoked from the main `Makefile` using the command `make minikube-stop`.

The script can also be invoked directly using the following command:
```bash
./deploy/minikube/minikube-stop.sh
```

#### `deploy/minikube/mac-registry-tunnel.sh` <a name="deploy-mac-registry-tunnel"></a>

**Note:** This script is for MacOS only.

The Minikube registry addon utilises a dynamically assigned port on MacOS operating systems instead of the default port (5000) for registry access. This deviation from the expected port can result in connectivity issues when trying to interact with the Minikube registry from your local environment. Follow the steps outlined in [MacOS Troubleshooting](#macos-troubleshooting) before attempting to run this script.

The `deploy/minikube/mac-registry-tunnel.sh` establishes port forwarding between your local port 5000 and the dynamically assigned port indicated in the warning message generated by Minikube.

The script can also be invoked directly using the following command:
```bash
./deploy/minikube/mac-registry-tunnel.sh
```

### Integration with Makefile

The provided automation scripts are seamlessly integrated with the project's main `Makefile`. By utilizing the `minikube-start` and `minikube-stop` targets, developers can easily initiate the creation and removal of the Minikube cluster.

Example:

```bash
make minikube-start   # Initializes the Minikube cluster.
make minikube-stop    # Completely removes the Minikube cluster.
make mac-registry-tunnel # For MacOS to to forward your local port 5000 to the dynamically assigned port.
```

## Creating the Minikube cluster <a name="minikube-create-cluster"></a>

Start Minikube and assign resources:

```bash
$ minikube start                                                     \
    --memory 8192 --cpus 4 --disk-size 40g                           \
    --insecure-registry registry.kube-system.svc.cluster.local       \
    --insecure-registry 172.17.0.1:5000
```

Export environment variables to point the shell to Minikube's docker-daemon:

```bash
$ eval $(minikube -p minikube docker-env)
```

Note the `-p` flage which specifies the profile name of the Minikube VM being
used.

Enable registries:

```bash
$ minikube addons enable registry
```

Note that insecure communication between the docker engine and registries was
enabled in the `start` command.

Configure a service to act as a DNS that runs inside the Minikube Kubernetes
cluster. An ingress controller allows the host to resolve locally deployed
services. Refer to the
[documentation](https://minikube.sigs.k8s.io/docs/handbook/addons/ingress-dns/)
for more information. Enable the addons:

```bash
$ minikube addons enable ingress
$ minikube addons enable ingress-dns
```

> :information_source: To complete this step, the Minikube IP needs to be added
  to the host as a DNS server. This will allow the host to resolve deployed
  services. Instructions are provided for [Linux](./minikube-DNS-linux.md) and
  [mac](./minikube-DNS-mac.md).


Enable metrics server:

```bash
$ minikube addons enable metrics-server
```

Record the Minikube IP address:

```bash
$ minikube ip
192.168.64.11
```

Enable load balancing services:

```bash
$ minikube addons enable metallb
$ minikube addons configure metallb
-- Enter Load Balancer Start IP: 192.168.64.100
-- Enter Load Balancer End IP:   192.168.64.200
```
## MacOS Troubleshooting <a name="macos-troubleshooting"></a>

If you encounter issues with Docker for MacOS, particularly when using Minikube and enabling registries, this guide provides solutions to common problems.

### Problem: Registry Addon Port Warning

When starting Minikube after enabling registries, you might receive a warning similar to the following:

```bash
Registry addon with docker driver uses port 50254; please use that instead of default port 5000
```

This warning indicates that Minikube's registry addon is using a randomly selected port (50254 in this case) instead of the default port 5000.

You can verify the existence of the repository on the selected port using the following command:

```bash
curl localhost:50254/v2/_catalog
{"repositories":[]}
```

### Issue Details

There are two primary issues:

1. **Port Conflict**: The local development scripts assume that port 5000 is available. However, this port on your MacOS device is often controlled by AirPlay.
2. **Port Forwarding**: Forwarding from your local port 5000 to the randomly selected port shown in the warning message is necessary.

### Resolution Steps

#### 1. Resolve Port Conflict

To ensure that port 5000 is available for use:

1. Go to `System Settings` and navigate to the `General Â» AirDrop & Handoff` screen.
2. On this screen:
   - Uncheck `Allow Handoff between this Mac and your iCloud devices`.
   - Set `Airdrop` to `No One`.
   - Uncheck `AirPlay Receiver`.
3. After updating your settings, restart your Mac. macOS will hold onto the port until the restart.

It's also possible to identify processes using port 5000 using the `lsof` (list open files) command:

```bash
lsof -i :5000
```

This will give you a list of processes using the port, along with their process IDs (PIDs).If you have been successful in carrying out the steps above, running this command should yield no results.

#### 2. Perform Port Forwarding

**Note:** This section has been automated. See [deploy/minikube/mac-registry-tunnel.sh](#deploy-mac-registry-tunnel)

To redirect your local port 5000 to the Docker engine's designated port, you can use `socat`:

Install `socat` if it's not already installed:

```bash
brew install socat
```

Replace `50254` with the port number provided in the warning during the initial cluster setup, then execute the following command:

```bash
socat TCP-LISTEN:5000,fork,reuseaddr TCP:localhost:50254
```

In a separate terminal tab, run the following command to verify the setup:

```bash
curl localhost:5000/v2/_catalog
{"repositories":[]}
```

A successful response indicates that you've successfully set up your local Docker registry.
